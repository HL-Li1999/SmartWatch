# 1.概述

​	本设计以STM32F103C8T6芯片作为主控，FreeRTOS作为操作系统，U8G2作为GUI。

​	使用多种外设如OLED显示屏、蜂鸣器、舵机、电机、MPU6050等，通过STM32驱动外设实现多种功能。

# 2.按键功能

​	按键包括四个——左、右、确定、退出，实现逻辑如下：

​	1.初始化对应四个GPIO口为**外部中断**，设定中断触发条件为输入下降沿触发。

​	2.使用消息队列来存储按键中断事件，在程序触发按键中断时，发送消息到消息队列中。

​	3.在其它任务中，每个循环周期都阻塞获取消息队列消息，并执行对应功能。

**如何去除按键抖动？**

当按键中断被判断为有效时，记录当时的时间 `lastKeyTime` ，只有下一次按键中断与 `lastKeyTime` 相隔 `k` 个时钟周期（例如40）时，该按键中断才会被判定为有效。

# 3.屏幕显示功能

​	STM32和OLED屏幕之间通过I2C协议进行通信，

​	1.初始化I2C通信的SCL和SDA对应的GPIO端口为开漏输出。

​	2.初始化U8G2，U8G2中的 `u8g2_gpio_and_delay_stm32()` 需要修改为程序的I2C通信函数。

​	3.在任意任务中可通过U8G2在屏幕上显示内容。

## 3.1.I2C协议

​	I2C是一种同步、半双工的通信协议，支持一主多从或多主多从。

![image-20240916232219960](https://raw.githubusercontent.com/HL-Li1999/CloudPic/master/img/image-20240916232219960.png)

​	如上图，I2C协议的主要内容如下：

- 起始条件：SCL高电平期间，SDA从高电平切换为低电平。

- 终止条件：SCL高电平期间，SDA从低电平切换为高电平。
- 主机发送一个字节：SCL低电平期间，主机修改SDA内容。SCL高电平期间，从机读取SDA内容。
- 主机接收一个字节：SCL低电平期间，从机修改SDA内容。SCL高电平期间，主机读取SDA内容。
- 主机发送应答：主机在接收完一个字节之后，在下一个时钟发送应答，数据0表示应答，数据1表示非应答。
- 主机接收应答：主机在发送完一个字节之后，在下一个时钟接收一位数据，判断从机是否应答，数据0表示应答，数据1表示非应答。

# 4.主界面时钟

​	在手表开机后，首先显示主界面时钟，该时钟会记录开机时间，在执行其它任务时仍然会在后台运行。实现逻辑如下：

​	1.创建一个定时器并启动定时器，每个定时器周期中断都记录当前已经过的中断数 `ticks`。

​	2.创建主界面时钟任务，进入主界面时将所有其它任务挂起，根据 `ticks` 求得开机时间的分钟数和秒数。

​	3.当按下确定键时，挂起主界面时钟任务，进入菜单任务。

# 5.菜单

​	菜单任务的主要工作为显示各个功能的图标，并根据按下的按键切换当前功能。实现逻辑如下：

​	1.初始化所有图标的位置（坐标可位于屏幕外，U8G2会自动优化）和当前功能索引。

​	2.当按下左、右键时，所有图标向左、右移动，索引进行减一、加一。

​	3.当按下确定键时，挂起菜单任务，根据当前索引进入对应功能的任务。

​	4.当按下退出键时，挂起菜单任务，恢复主界面时钟任务。

# 6.音乐播放

## 6.1. 模块逻辑

### 6.1.1 如何演奏一个音

​	蜂鸣器输入信号为频率等于*f*的PWM信号时，会发出音频为*f*的声音，音频和音调对照如下：

<img src="https://raw.githubusercontent.com/HL-Li1999/CloudPic/master/img/e56d12c9f31491dc34fd1910136a364b.png" alt="img" style="zoom:50%;" />
​	要使用蜂鸣器演奏一个音首先需要将蜂鸣器所接GPIO口初始化为PWM输出模式，通过TIM_SetAutoreload()改变PWM信号频率进而改变播放的音高，通过TIM_SetCompare1()改变PWM信号占空比进而改变播放的音量。

### 6.1.2 如何演奏一首歌

​	每首歌曲都由一个个音符组成，只要连续演奏这些音符就可以演奏出这首歌。以《孤勇者》为例，它的乐谱如下：

<img src="https://raw.githubusercontent.com/HL-Li1999/CloudPic/master/img/a6fb540f6fb25b5270c3f6b3d30001f5.png" alt="img" style="zoom:50%;" />

​	

​	依照乐谱，将要演奏的所有音符保存为一个数组，而后依次演奏数组每个元素即可：

```
#define   L1     262//低调1的频率
...

const uint16_t music_GuYongZhe[]=
{
    M3,M3,S,S,M1,M2,M1,M3,M3,S, //都是勇敢的
    M1,M2,M1,M2,M3,L6,M1,L6,M1,L6,M1,M2,M1,L7,L7,S,S, //你额头的伤口你的不同你犯的错
  	M3,M3,S,S,M1,M2,M1,M3,M3,S, //都不必隐藏
  	M1,M2,M1,M2,M3,L6,M1,L6,M1,L6,M1,M3,M2,L7,L7,S,S, 
    L6,M1,M6,M6,M6,M5,M6,M6,M5,M6,M5,M6,M5,M3,M3,M3,S,S, 
    L6,M1,M6,M6,M6,M5,M6,M5,M7,M7,M7,M6,M7,M7,M6,M3,M3,S,S, 
    M3,M5,M3,M2,M3,M2,M3,M2,S, 
    M3,M5,M3,M5,M3,M2,M3,M2,M3,M2,S, 
    M1,M2,M3,L6,M1,M3,M2,M3,M2,M1,M1,L6,L6,S,S,
    M6,M7,H1,H2,M7,H1,H1,S,	
    H1,M7,H1,H2,M7,H1,H1,S,
    H1,H2,H3,H2,H3,H2,H3,H3,H2,H3,H5,H3,S, 
    M6,M7,H1,H2,M7,H1,H1,H1,M7,H1,H2,M7,H1,H1,S,
  	H1,H2,H3,H2,H3,H2,H3,H3,H2,H3,H5,H3,S, 
    H5,H3, 
    H5,H3,S, 
  	H5,H3,H5,H6,H3,H5,S, 
    H5,H3,
  	H5,H3,S, 
    H5,H3,H5,H6,H3,H5,H5,H5,H3,H2,H2,H2,H1,H3,H3,H2,H2,H2,H1,H1,M6,M6,S,S, 
    H5,H5,H3,H2,H2,H2,H1,H3,H3,H2,H2,H2,H1,H1,M6,M6,S,S,
};
```
